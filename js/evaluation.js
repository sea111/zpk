$(function(){function e(){WPBridge.callMethod("JsInvokeNative","wpEncrypt",{key:l,params:m},function(t){if(codeValue=t.data.result,m.length>3)var o=codeValue.slice(3);else o="";$.ajax({type:"post",url:wpCommon.Url+"/wpwl/afterservice/evaluation",timeout:1e4,traditional:!0,data:{workOrder:codeValue[0],contents:codeValue[1],stars:codeValue[2],picUrls:o},success:function(t){"AES加密解密失败"==t.errMsg?u||($.ajax({type:"post",url:wpCommon.Url+"/wpwl/getKey",async:!0,success:function(t){l=t.data,localStorage.setItem("key",t.data),e()}}),u=!0):0==t.success?(WPBridge.callMethod("JsInvokeNative","wpShowToast",{message:"提交失败"},""),wpCommon.viewShow()):h.flag?WPBridge.callMethod("JsInvokeNative","wpFinishH5",{},""):WPBridge.callMethod("JsInvokeNative","wpStartAndFinishPage",{},function(){window.location.href="afterSaleDetail.html?suspectId="+h.suspectId})},error:function(e,t,o){"timeout"==t&&WPBridge.callMethod("JsInvokeNative","wpShowToast",{message:"超时"},""),wpCommon.viewShow()}})})}function t(){m=[g,k,c],I&&(m=m.concat(I))}function o(e){"#sure"==e?WPBridge.callMethod("JsInvokeNative","wpH5Back",{},""):"#cancle"==e&&($("#modal").hide(),$("#smark").hide())}function a(e,t){var o=template("test",e);$("#box").append(o);var a=0*-document.documentElement.clientWidth;p=t,$(".swiper-mask .swiper-wrapper").css("transform","translate3d("+a+"px, 0px, 0px)"),n(),WPBridge.callMethod("JsInvokeNative","wpBackListener",{back:!1},function(){$(".swiper-mask").remove()})}function i(){$(".top").css({position:"fixed"}),setTimeout(function(){var e=$(window).scrollTop();$(window).scrollTop(e)},1e3/60)}function n(){new Swiper(".swiper-mask",{zoom:!0,onSlideChangeEnd:function(e){$(".swiper-mask img").each(function(){var e=$(this);"none"!=e.css("transform")&&e.css("transition-duration",0)})}})}function s(o){var a="";a=-1!==f[o].indexOf("data:image/jpeg;base64")?f[o].split("data:image/jpeg;base64,")[1]:-1!==f[o].indexOf("data:image/png;base64")?f[o].split("data:image/png;base64,")[1]:f[o].split("data:image/jpg;base64,")[1];var i=f.length;$.ajax({url:wpCommon.Url+"/wpwl/afterservice/uploadPic",type:"POST",timeout:1e4,data:{noEncryptImageBase64:a},success:function(a){I.push(a.data.picUrl),o<i-1?s(++o):(t(),e(),f.length=0),S=!1},error:function(e,t,o){"timeout"==t&&WPBridge.callMethod("JsInvokeNative","wpShowToast",{message:"上传图片超时"},""),S=!0,wpCommon.viewShow()}})}WPBridge.callMethod("JsInvokeNative","wpShowLoadingDialog",{},"");var c,l,r,d,p,m,u="",h=getUrlRequest(),v=JSON.parse(localStorage.getItem("serviceDetail")),g=v.workOrder,w=v.serviceType,k="",f=[],I=(navigator.userAgent,[]),S="";!function(){$.ajax({url:wpCommon.Url+"/wpwl/getKey",type:"post",success:function(e){l=e.data}})}(),$(".valuate-left img").attr("src",v.iconURL),$(".valuate-name").html(v.name).siblings(".valuate-model").html(v.standard),$(".work").html(v.workOrder),"1"==w?$(".type").html("安装"):"2"==w&&$(".type").html("维修"),wpCommon.viewShow(),$(".gray").click(function(){for(var e=$(".gray"),t=$(this).attr("index"),o=$(".satisfaction-level"),a=0;a<t;a++)e.eq(a).attr("src","images/lightStar.png");for(var i=t;i<5;i++)e.eq(i).attr("src","images/grayStar.png");switch(c=Number(t)){case 1:o.html("很不满意");break;case 2:o.html("不满意");break;case 3:o.html("满意");break;case 4:o.html("比较满意");break;case 5:o.html("非常满意")}});var P=/\uD83C[\uDF00-\uDFFF]|\uD83D[\uDC00-\uDE4F]/g;$(".feel-inp").blur(function(){var e=$(".feel-inp").val().replace(/<script.*?>.*?<\/script>/gi,"");P.test(e)?(WPBridge.callMethod("JsInvokeNative","wpShowToast",{message:"不支持表情及特殊字符，提交失败。"},""),d=1):(d=0,k=$(this).val())}),$("#back").click(function(){$("#smark").css("display","block"),$("#modal").css("display","block")}),$("#smark").on("touchmove",function(){return!1}),$("#cancle").on("click",function(){o("#cancle")}),$("#sure").on("click",function(){o("#sure")}),$(".submit").click(function(){i(),$(".satisfaction-level").html()?d?WPBridge.callMethod("JsInvokeNative","wpShowToast",{message:"不支持表情及特殊字符，提交失败。"},""):(WPBridge.callMethod("JsInvokeNative","wpShowLoadingDialog",{},""),f.length?s(0):(t(),e()),WPBridge.callMethod("JsInvokeNative","wpHitDotEvent",{eventId:"h5_e094",otherId:""},""),WPBridge.callMethod("JsInvokeNative","wpNetwork",{},function(e){"0"==e.data.result&&WPBridge.callMethod("JsInvokeNative","wpShowToast",{message:"无连接，请检查网络"},"")})):WPBridge.callMethod("JsInvokeNative","wpShowToast",{message:"请先打分再提交哦"},"")}),$("#wpReload").click(function(){e()}),$(document).on("click","#delete",function(){$("#delete").remove(),$("#photo-top").remove(),$("#choose-pic").show(),$(".swiper-mask").remove(),f.splice(p-1,1),WPBridge.callMethod("JsInvokeNative","wpImageSelectDelete",{index:p-1},""),$(".photo-item div").eq(p).remove(),WPBridge.callMethod("JsInvokeNative","wpBackListener",{back:!0},"")}),$(document).on("click","#pre-back",function(){$("#photo-top").remove(),WPBridge.callMethod("JsInvokeNative","wpBackListener",{back:!0},""),$(".swiper-mask").remove()}),$(document).on("click",".photo-item img",function(){a({imgUrl:[this.src]},$(this).index("img")-6)}),$("textarea").on("focus",function(){/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)&&$(".top").css("position","absolute")}),$("textarea").on("change",function(){$(".number").html($(this).val().length+"/100")}),$("textarea").on("blur",function(){i()}),$("#choose-pic").click(function(){WPBridge.callMethod("JsInvokeNative","wpImageSelect",{},function(e){I.length=0;var t=e.data.result;f.length=0,$.each(t,function(e,t){f.push(t)}),r=f.length;t.length>=5&&$("#choose-pic").hide(),$(".photo-div").remove();for(var o=0;o<t.length;o++){var a=$(".photo-item div").eq(0).clone();a.addClass("photo-div").find("img").attr("src",t[o]),a.show(),$(".photo-item").append(a)}wpCommon.viewShow()})})});