$(function(){function t(t){for(var o=(new Date).getTime(),e="day",n=t.split("."),i=0;i<n.length;i++)n[i]=1*n[i];var a=new Date;a.setFullYear(n[0],n[1]-1,n[2]+1),a.setHours(0,0,0);var c=a.getTime()-o,s=Math.floor(c/864e5);return 0===s&&(s=Math.floor(c/36e5),e="hour"),{time:s,type:e}}function o(){var t=Math.ceil($(".discountBox").width()/19);$(".discountBox").each(function(){$(this).hasClass("complete")||($(this).width(19*t),$(this).addClass("complete"))})}function e(n,i){var c=wpCommon.Url+"/wpwl/activityDiscount/listCouponByPage",s="",u=$("#discountCouponTpl").html(),h="";switch(n){case"disCountContent":s=$("#discountContent"),h=1;break;case"undisCountContent":s=$("#undiscountContent"),h=0}if(l){l=!1;var m=a.suspectId,p=r[n];WPBridge.callMethod("JsInvokeNative","wpEncrypt",{key:i,params:[m,p,d,h]},function(a){var h=a.data.result;$.ajax({url:c,type:"post",data:{suspectId:h[0],pageIndex:h[1],pageSize:h[2],couponsType:h[3]},timeout:1e4,success:function(a){if("AES加密解密失败"==a.errMsg)aesFail||($.ajax({type:"post",url:wpCommon.Url+"/wpwl/getKey",success:function(t){i=t.data,localStorage.setItem("key",t.data),e(n,i)}}),aesFail=!0);else if(0==a.success)$("#box").hide(),$(".loading").show(),$(".middle img").attr("src","images/discountCoupon.png"),$(".middle p").html("您未领取优惠券"),$(".top div").html("优惠券"),wpCommon.viewShow();else{try{if(a.success){for(var c=a.data.coupons,h=0;h<c.length;h++)"disCountContent"==n&&(c[h].consume=2),c[h].activityStartTime=c[h].activityStartTime.replace(/-/g,"."),c[h].activityEndTime=c[h].activityEndTime.replace(/-/g,".");r[n]==Math.ceil(a.data.total/d)&&s.addClass("complete"),r[n]+=1,l=!0,c.length?laytpl(u).render(c,function(e){if(s.append(e),o(),"disCountContent"==n)for(var i=0;i<c.length;i++){var a=t(c[i].activityEndTime);"day"===a.type?$(".number").eq(i).html(+a.time+"天"):"hour"===a.type&&$(".number").eq(i).html(+a.time+"小时")}}):($("#box").hide(),$(".loading").show(),$(".middle img").attr("src","images/discountCoupon.png"),$(".middle p").html("您未领取优惠券"),$(".top div").html("优惠券"),wpCommon.viewShow())}}catch(t){$(".loading").show(),$(".middle img").attr("src","images/error_else.png"),$(".middle p").html("出错了，请稍后再试"),$(".top div").html("异常页面"),$(".look").hide(),$("#box").hide()}wpCommon.viewShow()}l=!0},error:function(t,o,e){"timeout"==o&&($("#box").hide(),$(".loading").show(),$(".top div").html("网络异常"),$(".look").hide()),wpCommon.viewShow()}})})}}function n(t){var o="";switch(t){case"discountContent":o="disCountContent";break;case"undiscountContent":o="undisCountContent"}return o}function i(t){var o=t.attr("content"),i=$("#"+o);$(".dis_content.current").removeClass("current"),i.addClass("current"),i.html().trim()||e(n(o),c),$(".look .more").attr("content","undiscountContent"),$(window).scrollTop(0)}WPBridge.callMethod("JsInvokeNative","wpShowLoadingDialog",{},function(){}),window.aesFail="";var a=getUrlRequest(),c="";!function(t,o){$.ajax({type:"post",url:wpCommon.Url+"/wpwl/getKey",async:!0,success:function(o){c=o.data,localStorage.setItem("key",o.data),e(t=t||"disCountContent",c)}})}();var s=null,r={disCountContent:1,undisCountContent:1},d=6,l=!0;$(window).on("scroll",function(){var t=$(this).scrollTop();clearTimeout(s),s=setTimeout(function(){t+$(window).height()>$(".dis_content.current").height()+$(".dis_content.current").offset().top-10&&$(".dis_content").each(function(){var t=$(this);if(t.hasClass("current"))return t.hasClass("complete")||e(n(t.attr("id")),c),!1})},300)}),$("#wpReload").click(function(){e(type,c),l=!0,r={disCountContent:1,undisCountContent:1},$(".dis_content.current").removeClass("current"),$("#disActContent").html("").addClass("current").removeClass("complete"),$(".look .more").attr("content","un_act_content"),e("disCountContent")});var u=!1;$(".more").click(function(){var t=$(this);$(".look").hide(),i(t),u=!0}),WPBridge.callMethod("JsInvokeNative","wpBackListener",{back:!1},function(){$("#back").click()}),$("#back").on("click",function(){u?(u=!1,$("#discountContent").addClass("current"),$("#undiscountContent").removeClass("current"),$(".look").show(),i($(".current")),$(window).scrollTop(0),$(".loading").hide(),$("#box").show()):WPBridge.callMethod("JsInvokeNative","wpH5Back",{},"")}),$("#discountContent").on("click",".discountBox",function(){$(this).find(".icons").hide();var t=$(this).attr("couponId"),o=$(this).attr("activityId"),e=$(this).attr("couponName").slice(0,-3);localStorage.setItem("couponName",e),WPBridge.callMethod("JsInvokeNative","wpHitDotEvent",{eventId:"h5_e082",otherId:o},""),window.location.href="discountDetail.html?pageId=H5_C019&otherId="+o+"&couponId="+t}),$("#undiscountContent").on("click",".unactivity",function(){var t=$(this).attr("couponId"),o=$(this).attr("activityId"),e=$(this).attr("couponName").slice(0,-3);localStorage.setItem("couponName",e),WPBridge.callMethod("JsInvokeNative","wpHitDotEvent",{eventId:"h5_e082",otherId:o},""),window.location.href="discountDetail.html?pageId=H5_C019&otherId="+o+"&couponId="+t})});