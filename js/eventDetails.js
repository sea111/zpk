$(function(){function t(t){$.ajax({url:"/wpwl/getKey",type:"post",success:function(e){h=e.data,o(t)}})}function e(t,e){WPBridge.callMethod("JsInvokeNative","wpEncrypt",{key:h,params:t},function(t){e&&e(t)})}function o(t){var o=d.posId||"";"undefined"==o&&(o=""),e([d.activityId,o],function(e){i(e,t)})}function i(e,o){var i=e.data.result;$.ajax({url:g+"/wpwl/activity/getActivityDetail",data:{activityId:i[0],posId:i[1]},type:"post",timeout:1e4,beforeSend:function(){$(".loadEffect").show().siblings(".middle").hide()},success:function(e){ajaxComplete(e,function(){o||t(!0)},function(){$("#share").show(),$(".content").show(),m=e.data,$(".loading").hide(),m.gmtStart=m.gmtStart.replace(/-/g,"."),m.gmtEnd=m.gmtEnd.replace(/-/g,"."),$("#act_time").html(m.gmtStart+"至"+m.gmtEnd),$("#act_place").html(m.address[0]),$("#poster").attr("src",m.picUrl),$(".act_content").html(m.content),$(".top div").html(m.brandName),$("#wrap").show(),imgError("images/default_error2.png"),localStorage.setItem("storeAddress",JSON.stringify(m.address)),1==m.address.length&&$(".more_place").hide(),f&&(wpCommon.viewShow(),f=!1)})},error:function(t,e,o){ajaxError()},complete:function(){WPBridge.callMethod("JsInvokeNative","wpDismissLoadingDialog",{a:"1"})}})}function a(t,e){t=t||1;var o=d.activityId,i=d.suspectId||"";i&&"undefined"!=i?$.ajax({url:g+"/share/product/getActivityProducts",type:"post",timeout:1e4,data:{activityId:o,pageIndex:t,pageSize:s,suspectId:i},success:function(o){ajaxComplete(o,function(){e||a(t,!0)},function(){$("#share").show(),$(".loading").hide();var t=o.data,e=$("#product_list_html").html();laytpl(e).render(t.list,function(t){$(".product_list ul").append(t),$(".product_list img").on("error",function(){$(this).attr("src","images/default_error2.png")})}),c++,u=Math.ceil(t.total/s),imgError("images/default_error2.png")}),l=!0},error:function(t,e,o){ajaxError()}}):WPBridge.callMethod("JsInvokeNative","wpGetUserId",{},function(n){i=n.data.result?n.data.result:"",$.ajax({url:g+"/share/product/getActivityProducts",type:"post",timeout:1e4,data:{activityId:o,pageIndex:t,pageSize:s,suspectId:i},success:function(o){ajaxComplete(o,function(){e||a(t,!0)},function(){$("#share").show(),$(".loading").hide();var t=o.data,e=$("#product_list_html").html();laytpl(e).render(t.list,function(t){$(".product_list ul").append(t),$(".product_list img").on("error",function(){$(this).attr("src","images/default_error2.png")})}),c++,u=Math.ceil(t.total/s),imgError("images/default_error2.png")}),l=!0},error:function(t,e,o){ajaxError()}})})}function n(t){1==m.status?$.ajax({url:g+"/share/activityDiscount/shareCoupon",data:{activityId:m.id,suspectId:t,posId:m.posId},type:"post",success:function(e){if(e.success){var o=e.data,i=o.brandIcon,a=o.id,n=m.id,r="好友为您带来“"+m.brandName+"”专属优惠券";WPBridge.callMethod("JsInvokeNative","wpShareProduct",{type:"3",shareId:n,shareTitle:"分享有礼！",shareText:r,shareUrl:"https://h5.wpwl.org/h5/shareRebate.html?aid="+n+"&rid="+a+"&sid="+t,shareImg:i},""),wpCommon.viewShow()}else WPBridge.callMethod("JsInvokeNative","wpShowToast",{message:"出错了，请稍后再试"})},error:function(){WPBridge.callMethod("JsInvokeNative","wpShowToast",{message:"出错了，请稍后再试"})}}):WPBridge.callMethod("JsInvokeNative","wpShowToast",{message:"抱歉，该活动已失效"})}function r(){var t=d.suspectId||"";"undefined"==t&&(t=""),t&&"undefined"!==t?n(t):WPBridge.callMethod("JsInvokeNative","wpGetUserId",{},function(t){t.data.result?n(t.data.result):WPBridge.callMethod("JsInvokeNative","wpLogin",{})})}var d=getUrlRequest(),c=1,s=4,l=!0,u=0,p=null,h=null,g=wpCommon.Url,m={},f=!0;t(),$(".more_place").on("click",function(){window.location.href="storeAddress.html?pageId=H5_C022&type=1"}),a(c);var v=document.documentElement.clientHeight-document.documentElement.clientWidth/7.5*.88;$(".loading").css("height",v+"px"),$("#wpReload").click(function(){l=!0,i()}),$("body").on("click",".product_item",function(){var t=$(this).attr("pid");WPBridge.callMethod("JsInvokeNative","wpHitDotEvent",{eventId:"h5_e070",otherId:t},function(){}),window.location.href="detail.html?pageId=H5_A008&otherId="+t+"&productId="+t+"&type=1"}),$(window).on("scroll",function(){var t=$(this).scrollTop();clearTimeout(p),p=setTimeout(function(){var e=t+$(window).height(),o=Math.ceil($(".product_item").length/2);e>$("#wrap").height()+$(".product_item").height()*o+$(".top").height()-200&&l&&c<=u&&($(".loading").show().siblings(".middle").hide(),a(c))},300)}),$(".act_btn .share_btn").on("click",function(){var t=m.id;WPBridge.callMethod("JsInvokeNative","wpHitDotEvent",{eventId:"h5_e072",otherId:t},function(){}),r()}),$("#share").on("click",function(){var t=m.id;WPBridge.callMethod("JsInvokeNative","wpHitDotEvent",{eventId:"h5_e071",otherId:t},function(){}),r()}),$("#back").on("click",function(){WPBridge.callMethod("JsInvokeNative","wpH5Back",{},"")})});