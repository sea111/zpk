$(function(){function e(){$.ajax({url:wpCommon.Url+"/wpwl/getKey",data:{versionId:"27"},success:function(e){key=e.data,localStorage.setItem("key",e.data),t(key)}})}function t(t){var m=getUrlRequest().failType;a=getUrlRequest().labelCode,"1"==m?WPBridge.callMethod("JsInvokeNative","wpEncrypt",{key:t,params:[a]},function(t){codeValue=t.data.result[0],$.ajax({url:wpCommon.Url+"/wpwl/scan/result",type:"post",data:{labelCode:codeValue,versionId:"27"},success:function(t){if("AES加密解密失败"==t.errMsg)aesFail||(e(),aesFail=!0);else if(0==t.success)$(".top div").html("验证有误"),$(".result img").attr("src","images/vrf_wrong.png").addClass("verify_error").siblings("p").html("很抱歉，没有找到您扫描的商品"),$(".fail").show().siblings(".top").show(),wpCommon.viewShow();else try{var o=t.data;if(s=o.showType,i=o.brandId,l=o.brandName,$(".goods_name span").html(l),$(".top div").html("扫描结果"),o.brandLogoUrl?$("#brand_logo img").attr("src",o.brandLogoUrl):$("#brand_logo img").attr("src","images/default_error2.png").css({maxWidth:"75%",maxHeight:"75%",marginTop:"0.20rem"}),0==s){var a="<strong style='color:#d8a31f'>"+o.productName+"</strong>";$("#brand_name").html(o.brandName+"提示您").siblings("#product_name").html("您购买的"+a+"是正品"),$("#time").html(o.bindTime),$("#goods_detail").html(o.productName+o.productType),$(".img-border img").attr("src",o.productPicUrl),o.specialCode&&(n=o.specialCode,d=o.customerName),r=o.productId}else{var m=o.categoryList;if($("#brand_name").html(o.orgName+"提示您").siblings("#product_name").html("您购买的产品是正品"),$(".img-border img").attr("src",o.brandLogoUrl),2==s){o.authText&&$(".distri-info").show().html(o.authText);for(var g=0;g<m.length;g++)c.push(m[g].id)}else 1==s&&(c.push(o.categoryId),$("#goods_detail").html(o.categoryName));m&&(m[1]&&$("#time").css({color:"#333",fontSize:"0.3rem",fontWeight:"normal"}).html(m[1].name),m[2]&&$("#time").css({color:"#333",fontSize:"0.3rem",fontWeight:"normal"}).html(m[1].name+"..."),$("#goods_detail").css("marginBottom","0.1rem").html(m[0].name))}$("img").each(function(){var e=$.Deferred();$(this).bind("load",function(){e.resolve()}).bind("error",function(){$(this).attr("src","images/default_error2.png")})}),wpCommon.viewShow(),WPBridge.callMethod("JsInvokeNative","wpUpOtherId",{otherId:r},function(){}),$(".success").show().siblings(".top").show()}catch(e){}},error:function(){wpCommon.viewShow(),$(".loading").css("height",wholeHei+"px").show()}})}):"0"==m||"2"==m||"3"==m?o("验证有误","images/vrf_wrong.png","verify_error"):"4"==m?o("扫描超时","images/scan_delay.png","scan_delay","扫描超时，请重新扫描"):"6"==m?($(".top div").html("扫描失败"),WPBridge.callMethod("JsInvokeNative","wpEncrypt",{key:t,params:[a]},function(t){codeValue=t.data.result[0],$.ajax({url:wpCommon.Url+"/wpwl/scan/result",type:"post",data:{labelCode:codeValue,versionId:"27"},success:function(t){if("AES加密解密失败"==t.errMsg)aesFail||(e(),aesFail=!0);else{var o=t.data,s=o.productName;r=o.productId;var i="<strong id='findItem'>"+s+"</strong>";$(".result img").attr("src","images/scan_failed.png").addClass("scan_failed").siblings("p").html("扫描失败，是否在找"+i),$(".fail").show().siblings(".top").show(),$("#findItem").click(function(){window.location.href="detail.html?type=1&fromScan=true&pageId=H5_A008&otherId="+r+"&labelCode="+a+"&productId="+r}),$("img").each(function(){var e=$.Deferred();$(this).bind("load",function(){e.resolve()}).bind("error",function(){$(this).attr("src","images/default_error2.png")})}),WPBridge.callMethod("JsInvokeNative","wpUpOtherId",{otherId:r},""),wpCommon.viewShow()}},error:function(){wpCommon.viewShow(),$(".loading").css("height",wholeHei+"px").show()}})})):"5"==m&&o("扫描失败","images/scan_net.png","scan_error","抱歉，网络受阻，请再次扫描")}function o(e,t,o,a){$(".top div").html(e),$(".result img").attr("src",t).addClass(o),$(".result p").html(a),$(".fail").show().siblings(".top").show(),wpCommon.viewShow()}WPBridge.callMethod("JsInvokeNative","wpShowLoadingDialog",{},""),WPBridge.callMethod("JsInvokeNative","wpGetVersionCode",{},function(e){var t=Number(e.data.result.replace(".",""));localStorage.setItem("version",t)}),window.aesFail="";var a,r,s,i,l,n,d,c=[];e(),$("#goods_info").click(function(){var e;0==s?(n&&(localStorage.setItem("specialCode",n),localStorage.setItem("customerName",d)),e="detail.html?type=1&fromScan=true&pageId=H5_A008&otherId="+r+"&labelCode="+a+"&productId="+r):3==s?(e="list.html?pageId=H5_A008",localStorage.setItem("brandid",i),localStorage.setItem("brandname",l)):(localStorage.setItem("brandname",l),localStorage.setItem("brandid",i),localStorage.setItem("categoryId",JSON.stringify(c)),e="category.html?pageId=H5_A008"),window.location.href=e}),$("#back").click(function(){WPBridge.callMethod("JsInvokeNative","wpFinishH5",{},"")}),$("#rescan").click(function(){WPBridge.callMethod("JsInvokeNative","wpStartScan",{},"")});var m=navigator.userAgent;$("#search").on("focus",function(){(m.indexOf("Android")>-1||m.indexOf("Linux")>-1)&&$("#wrap").css({bottom:"5rem"})}),$("#search").on("blur",function(){$("#wrap").css({bottom:""})}),$("#search").on("keypress",function(e){if(""!=$(this).val()&&13==e.keyCode){WPBridge.callMethod("JsInvokeNative","wpHitDotEvent",{eventId:"h5_e037",otherId:$(this).val()},function(){}),$("#wrap").css({bottom:""});$(this).val();if(new RegExp("[ /a-zA-Z0-9一-龥-——()（）]").test($(this).val())){var t=(t=(t=(t=$(this).val().replace(/（/g,"(")).replace(/）/g,")")).replace(/—/g,"-")).replace(/<[^>]*>/g,"");localStorage.setItem("searchVal",t),localStorage.removeItem("brandid"),window.location.href="searchResult.html"}else WPBridge.callMethod("JsInvokeNative","wpShowToast",{message:"您输入的字符不合法"},"")}else""==$(this).val()&&13==e.keyCode&&WPBridge.callMethod("JsInvokeNative","wpShowToast",{message:"请输入您要查询的内容"},"")})});